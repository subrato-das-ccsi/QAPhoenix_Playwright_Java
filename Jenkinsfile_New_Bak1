  import hudson.model.Cause.UserIdCause

def creds = ''
def nodeName = ''

pipeline {
	agent none
	tools { maven '3.8.7'}
	parameters {
	  choice(name: 'ExecEnvironment', choices: ['qa'], description: 'Pick an environment to run scripts')
        string(name: 'ModuleName', defaultValue: 'EndToEndTest1To4.xml', description: 'Pick scripts by features')
        string(name: 'testGroups', defaultValue: 'regression', description: 'Select the testcases by group, For example: regression, smoke')
        booleanParam(name: 'uploadResults', defaultValue: false, description: 'Do you want to upload the results to TestRail directly after execution?')
        string(name: 'TestRunId', defaultValue: '', description: 'Enter TestRail testrun ID here to upload the final results')
        choice(name: 'Browser', choices: ['chrome', 'firefox', 'edge'], description: 'Pick an environment to run scripts')
        booleanParam(name: 'clearVideoDir', defaultValue: false, description: 'Clear videos folder before test run')
        booleanParam(name: 'enableVideoRecording',defaultValue: false, description: 'Enable Video Recording')
        booleanParam(name: 'recordFailedOnly', defaultValue: true, description: 'Enable Video Recording for fail only or for all cases')
        string(name: 'ADLoginID', defaultValue: 'j2global\\vinoth.xavier', description: 'Your OneLogin userId, not the e-mail address, used to access secretserver')
        password(name: 'ADLoginPassword', defaultValue: '', description: 'Your OneLogin password')
        string(name: 'SalesForceLoginID', defaultValue: 'subrato.das@consensus.com.ccsi-sf.qa', description: 'Your SalesForce CCSI LoginID, not the e-mail address')
        password(name: 'SalesForcePassword', defaultValue: 'Lkjhgf987654*', description: 'Your SalesForce CCSI Password')
	}

	stages {
		stage('prepare') {
		  agent { label 'WebAgent' }
			steps {
					script {
				    def salesforceLoginID = params.SalesForceLoginID
                    def salesforcePassword = params.SalesForcePassword
                    def salesforceCreds = "${salesforceLoginID} :: ${salesforcePassword}"

					def response;
					def responseError = false;
                    def triggeredByTimer = !currentBuild.getBuildCauses('hudson.triggers.TimerTrigger$TimerTriggerCause').isEmpty()

                    if (params.clearVideoDir)
                         {
                            echo "User opted to clear video folder before test run."
                            def videoDir = "${env.WORKSPACE}/test-output/report/videos"
                            if (isUnix()) {
                                sh "rm -rf '${videoDir}'"
                            } else {
                                bat "if exist \"${videoDir}\" rmdir /s /q \"${videoDir}\""
                            }
                        } else {
                            echo "Skipping video folder cleanup."
                        }
					try {
						if (triggeredByTimer) {
							echo "Credentials to connect to SecretServer are taken automatically from Jenkins"
							withCredentials([usernamePassword(credentialsId: 'vinoth.xavier', usernameVariable: 'ADLoginID', passwordVariable: 'ADLoginPassword')]) {
								response = httpRequest httpMode: 'POST', acceptType: 'APPLICATION_JSON', contentType: 'APPLICATION_FORM_DATA',
								requestBody: "username=${env.ADLoginID}&password=${env.ADLoginPassword}&grant_type=password",
								url: 'https://secretserver.j2noc.com/SecretServer/oauth2/token'
							}
						}
						else
						{
							echo "Job was triggered by a user."
							response = httpRequest httpMode: 'POST', acceptType: 'APPLICATION_JSON', contentType: 'APPLICATION_FORM_DATA',
							requestBody: "username=${ADLoginID}&password=${ADLoginPassword}&grant_type=password",
							url: 'https://secretserver.j2noc.com/SecretServer/oauth2/token'
						}
					} catch(Exception e) {
						echo("Ensure you're providing all the necessary details correct when triggering this job.")
						error("Connection attempt to SecretServer failed: ${e.getMessage()}.")
						responseError = true;
					}
					if(!responseError) {
						def data = readJSON text: response.content
						def access_token = data.access_token

						def secretIds = ['14944']
						secretIds.each{ item ->
							try {
								def credname = httpRequest httpMode: 'GET', acceptType: 'APPLICATION_JSON', customHeaders: [[maskValue: false, name: 'Authorization', value: "Bearer $access_token"]],
								url: "https://secretserver.j2noc.com/SecretServer/api/v1/secrets/lookup/$item"
								def cred = readJSON text: credname.content
								def name = cred.value

								def username = httpRequest httpMode: 'GET', acceptType: 'APPLICATION_JSON', customHeaders: [[maskValue: false, name: 'Authorization', value: "Bearer $access_token"]],
								url: "https://secretserver.j2noc.com/SecretServer/api/v1/secrets/$item/fields/username"

								def password = httpRequest httpMode: 'GET', acceptType: 'APPLICATION_JSON', customHeaders: [[maskValue: false, name: 'Authorization', value: "Bearer $access_token"]],
								url: "https://secretserver.j2noc.com/SecretServer/api/v1/secrets/$item/fields/password"

								creds = (creds + "\nSalesForceCreds = ${salesforceCreds}" +"\n" + name + " = " + username.content.substring(1, username.content.length() - 1) + " :: " + password.content.substring(1, password.content.length() - 1))
							} catch(Exception e) {
								error("HTTP request failed: ${e.getMessage()}")
							}
						}
					}
				}
			}
		}
		stage('test') {

			agent { label 'WebAgent' }

			steps {
				script {
					dir("${env.WORKSPACE}"){
						writeFile file: "credentials.${ExecEnvironment}", text: "$creds"

						if (isUnix()) {
							sh 'mvn -U -s settings.xml -q clean compile test -P ${ExecEnvironment} -D uploadResults=${uploadResults} -D skipTests=false -D headless=false -D webBrowser=${Browser} -D testgroups=${testGroups} -D testRunId=${TestRunId} -D suiteXmlFiles=${ModuleName} -D enableVideoRecording=${enableVideoRecording} -D recordFailedOnly=${recordFailedOnly}'
						}
						else {
							bat 'mvn -U -s settings.xml -q clean compile test -P %ExecEnvironment% -D uploadResults=%uploadResults% -D skipTests=false -D headless=false -D webBrowser=%Browser% -D testgroups=%testGroups% -D testRunId=%TestRunId% -D suiteXmlFiles=%ModuleName% -D enableVideoRecording=%enableVideoRecording% -D recordFailedOnly=%recordFailedOnly%'
						}
					}
				}
			}
			post {
				always {
					script {
						dir("${env.WORKSPACE}"){
							junit(
								allowEmptyResults: true,
								testResults: 'test-output/report/testng-results.xml'
							)

							publishHTML(target: [
								allowMissing: true,
								alwaysLinkToLastBuild: true,
								keepAll: true,
								reportDir: 'test-output',
								reportFiles: 'custom-emailable-report.html',
								reportName: 'HTML Report'
							])

							def reportUrl = "${env.BUILD_URL}HTML_20Report/"
							echo reportUrl

							if (currentBuild.result == 'SUCCESS') {
								slackSend (
									channel: '#healthcheck_gui_jobs',
									message: ":white_check_mark:PASSED Jenkins Job: ${env.JOB_NAME}, Build: ${env.BUILD_NUMBER}, Status: ${currentBuild.result}.\nView the HTML Report on Jenkins: ${reportUrl}",
								)
							}
							if (currentBuild.result == 'UNSTABLE') {
								slackSend (
									channel: '#healthcheck_gui_jobs',
									message: ":x:FAILED Jenkins Job: ${env.JOB_NAME}, Build: ${env.BUILD_NUMBER}, Status: ${currentBuild.result}.\nView the HTML Report on Jenkins: ${reportUrl}\nContact: @vinoth.xavier",
								)
							}
							if (currentBuild.result == 'FAILURE') {
								slackSend (
									channel: '#healthcheck_gui_jobs',
									message: ":x:FAILED Jenkins Job: ${env.JOB_NAME}, Build: ${env.BUILD_NUMBER}, Status: ${currentBuild.result}.\nView the HTML Report on Jenkins: ${reportUrl}\nContact: @vinoth.xavier",
								)
							}
						}
					}
				}
			}
		}
	}
}
