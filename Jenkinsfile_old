def creds = ''
def suiteFilePath = "${env.WORKSPACE}/src/test/resources/testng/${ModuleName}"
pipeline {
    agent { label 'WebAgent' }
    tools { maven 'Maven3.8.7' }
    parameters {
        choice(name: 'ExecEnvironment', choices: ['qa'], description: 'Pick an environment to run scripts')
        string(name: 'ModuleName', defaultValue: 'EndToEndTest1To4.xml', description: 'Pick scripts by features')
        string(name: 'testGroups', defaultValue: 'regression', description: 'Select the testcases by group, For example: regression, smoke')
        booleanParam(name: 'uploadResults', defaultValue: false, description: 'Do you want to upload the results to TestRail directly after execution?')
        string(name: 'TestRunId', defaultValue: '', description: 'Enter TestRail testrun ID here to upload the final results')
        choice(name: 'Browser', choices: ['chrome', 'firefox', 'edge'], description: 'Pick an environment to run scripts')
        booleanParam(name: 'enableVideoRecording', defaultValue: true, description: 'Enable Video Recording')
        booleanParam(name: 'recordFailedOnly', defaultValue: true, description: 'Enable Video Recording for fail only or for all cases')
        string(name: 'ADLoginID', defaultValue: 'j2global\\subrato.das', description: 'Your OneLogin userId, not the e-mail address, used to access secretserver')
        password(name: 'ADLoginPassword', defaultValue: 'Poiuyt987654*', description: 'Your OneLogin password')
        string(name: 'SalesForceLoginID', defaultValue: 'subrato.das@consensus.com.ccsi-sf.qa', description: 'Your SalesForce CCSI LoginID, not the e-mail address')
        password(name: 'SalesForcePassword', defaultValue: 'Asdfgh987654*', description: 'Your SalesForce CCSI Password')
    }
    stages {
        stage('test1') {
            agent { label 'WebAgent && !AWSUSW* && !qa_instance_*' }
            steps {
//                 dir("src/test/resources/environments/${ExecEnvironment}") {
//                     unstash('offercodes.csv')
//                 }
                script {
                    writeFile file: "credentials.${ExecEnvironment}", text: "$creds"
                    if (isUnix()) {
                        sh 'echo $PATH'
                       def reportDir = "${env.WORKSPACE}/test-output/report"
                            if (!fileExists(reportDir))
                            {
                                new File(reportDir).mkdirs()
                            }
                       sh "mvn -s settings.xml -gs settings.xml -U -q clean compile test -P ${ExecEnvironment} -D uploadResults=${uploadResults} -D skipTests=false -D headless=false -D webbrowser=${Browser} -D testgroups=${testGroups} -D testRunId=${TestRunId} -D enableVideoRecording=${enableVideoRecording} -D suiteXmlFile="${suiteFilePath}" -D recordFailedOnly=${recordFailedOnly}"
                    }
                }
            }
        }
        stage('test2') {
            steps {
                script {
                    dir("${env.WORKSPACE}") {
                        if (isUnix()) {
                            def reportDir = "${env.WORKSPACE}/test-output/report"
                            if (!fileExists(reportDir))
                            {
                                new File(reportDir).mkdirs()
                            }
                            sh "mvn -s settings.xml -gs settings.xml -U -q clean compile test -P ${ExecEnvironment} -D uploadResults=${uploadResults} -D skipTests=false -D headless=false -D webbrowser=${Browser} -D testgroups=${testGroups} -D testRunId=${TestRunId} -D enableVideoRecording=${enableVideoRecording} -D suiteXmlFile="${suiteFilePath}" -D recordFailedOnly=${recordFailedOnly}"
                        } else {
                         def reportDir = "${env.WORKSPACE}\\test-output\\report"
                                if (!fileExists(reportDir))
                                {
                                    bat "mkdir \"${reportDir}\""
                                }
                            powershell("""
                                mvn -s settings.xml -gs settings.xml -U -q clean compile test -P $env:ExecEnvironment -D uploadResults=$env:uploadResults -D skipTests=false -D headless=false -D webbrowser=$env:Browser -D testgroups=$env:testGroups -D testRunId=$env:TestRunId -D enableVideoRecording=$env:enableVideoRecording -D recordFailedOnly=$env:recordFailedOnly -D suiteXmlFile=$env:suiteFilePath
                            """)
                        }
                    }
                }
            }
        }
        stage('test3') {
            options {
                ansiColor('xterm')
            }
            steps {
                ansiColor('xterm')
                script {
                    dir("${env.WORKSPACE}") {
                        if (isUnix()) {
                          def reportDir = "${env.WORKSPACE}/test-output/report"
                            if (!fileExists(reportDir))
                            {
                                new File(reportDir).mkdirs()
                            }
                            sh "mvn -s settings.xml -gs settings.xml -U -q clean compile test -P ${ExecEnvironment} -D uploadResults=${uploadResults} -D skipTests=false -D headless=false -D webbrowser=${Browser} -D testgroups=${testGroups} -D testRunId=${TestRunId} -D enableVideoRecording=${enableVideoRecording} -D recordFailedOnly=${recordFailedOnly} -D suiteXmlFile=${ModuleName}"
                        } else {
                              def reportDir = "${env.WORKSPACE}\\test-output\\report"
                                if (!fileExists(reportDir))
                                {
                                    bat "mkdir \"${reportDir}\""
                                }
                            powershell("""
                                mvn -s settings.xml -gs settings.xml -U -q clean compile test -P $env:ExecEnvironment -D uploadResults=$env:uploadResults -D skipTests=false -D headless=false -D webbrowser=$env:Browser -D testgroups=$env:testGroups -D testRunId=$env:TestRunId -D enableVideoRecording=$env:enableVideoRecording -D recordFailedOnly=$env:recordFailedOnly -D suiteXmlFile=$env:suiteFilePath
                            """)
                        }
                    }
                }
            }
        }
    }
    post {
        always {
            script {
                dir("${env.WORKSPACE}") {
                    junit(
                        allowEmptyResults: true,
                        testResults: 'test-output/report/testng-results.xml'
                    )
                    publishHTML(target: [
                        allowMissing: false,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: 'test-output/report',
                        reportFiles: 'custom-emailable-report.html',
                        reportName: 'HTML Report'
                    ])
                    def reportUrl = "${env.BUILD_URL}HTML_20Report/"
                    echo reportUrl
                    if (currentBuild.result == 'SUCCESS') {
                        slackSend (
                            channel: '#healthcheck_gui_jobs',
                            message: ":white_check_mark:PASSED Jenkins Job: ${env.JOB_NAME}, Build: ${env.BUILD_NUMBER}, Status: ${currentBuild.result}.\nView the HTML Report on Jenkins: ${reportUrl}",
                        )
                    }
                }
            }
        }
    }
}